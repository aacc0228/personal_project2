<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT æ™ºæ…§å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* ç°¡æ˜“çš„ ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f4f6; /* gray-200 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* è®“ Markdown æ›è¡Œç”Ÿæ•ˆ */
        .markdown-content {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="notification" style="display: none;" class="fixed top-5 right-5 z-50 px-4 py-2 rounded-lg text-white transition-opacity duration-300"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ğŸ¤– AI åŠ©åŠ›çš„ IT æ™ºæ…§å„€è¡¨æ¿</h1>
            <p class="text-gray-600 mt-2">è«‹åœ¨ä¸‹æ–¹çš„é ç±¤ä¸­é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„åŠŸèƒ½ã€‚</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-btn-logs" class="tab-button active text-lg font-medium py-3 px-5 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                    ğŸ“ Apache éŒ¯èª¤æ—¥èªŒ
                </button>
                <button id="tab-btn-qa" class="tab-button text-lg font-medium py-3 px-5 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                    ğŸ’¡ IT çŸ¥è­˜åº«å•ç­”
                </button>
            </nav>
        </div>

        <main>
            <div id="tab-content-logs" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold w-full sm:w-auto">é¡¯ç¤ºå¾ Azure SQL è³‡æ–™åº«è®€å–çš„æ—¥èªŒ</h2>
                        <button id="refresh-logs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 12M20 20l-1.5-1.5A9 9 0 003.5 12"></path></svg>
                            é‡æ–°æ•´ç†
                        </button>
                    </div>

                    <div id="filter-controls" class="bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="filter-status" class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                                <select id="filter-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="æœªé–‹å§‹">æœªé–‹å§‹</option>
                                    <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                                    <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-date" class="block text-sm font-medium text-gray-700">LOG æ—¥æœŸ</label>
                                <input type="date" id="filter-date" class="mt-1 block w-full border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md p-2">
                            </div>
                            <div>
                                <label for="filter-ticket" class="block text-sm font-medium text-gray-700">è™•ç†å–®è™Ÿ</label>
                                <input type="text" id="filter-ticket" placeholder="ä¾å–®è™Ÿæœå°‹..." class="mt-1 block w-full border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md p-2">
                            </div>
                            <div class="flex space-x-2">
                                <button id="filter-search-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">æŸ¥è©¢</button>
                                <button id="filter-clear-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">æ¸…é™¤</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="logs-error-display" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert"></div>

                    <div id="logs-loader" class="hidden flex justify-center items-center my-8">
                        <div class="loader"></div>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="logs-table" class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">ç‹€æ…‹</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">LOG æ™‚é–“</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/6">LOG å…§å®¹é è¦½</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">è™•ç†å–®è™Ÿ</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="pagination-controls" class="flex justify-between items-center mt-4">
                        </div>
                </div>
            </div>

            <div id="tab-content-qa" class="tab-content">
                
                {% if is_ai_configured %}
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-2">IT çŸ¥è­˜åº«å•ç­”</h2>
                    <p class="text-gray-600 mb-4">å„ªå…ˆå¾ Qdrant å‘é‡çŸ¥è­˜åº«å°‹æ‰¾è§£ç­”ã€‚è‹¥æ‰¾ä¸åˆ°ï¼Œå°‡ä½¿ç”¨é€šç”¨çš„ Gemini æ¨¡å‹å›ç­” IT ç›¸é—œå•é¡Œã€‚</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <form id="qa-form">
                                <label for="it-question-input" class="block text-sm font-medium text-gray-700 mb-1">è«‹è¼¸å…¥æ‚¨çš„ IT å•é¡Œ</label>
                                <textarea id="it-question-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•æ¸…é™¤ Chrome ç€è¦½å™¨çš„å¿«å–ï¼Ÿ"></textarea>
                                <button type="submit" id="qa-submit-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex justify-center items-center">
                                    æŸ¥è©¢çŸ¥è­˜åº«
                                </button>
                            </form>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">AI å›æ‡‰:</h3>
                            <div id="qa-loader" class="hidden flex justify-center items-center my-8">
                                <div class="loader"></div>
                            </div>
                            <div id="qa-answer-output" class="markdown-content text-gray-800"></div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                    <p class="font-bold">AI åŠŸèƒ½æœªè¨­å®š</p>
                    <p>ç®¡ç†å“¡å°šæœªåœ¨ä¼ºæœå™¨ä¸Šè¨­å®š Google Gemini API é‡‘é‘°ã€‚æ­¤åŠŸèƒ½ç›®å‰ç„¡æ³•ä½¿ç”¨ã€‚</p>
                </div>
                {% endif %}

            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>ç”± Flask èˆ‡ Google Gemini é©…å‹•</p>
        </footer>
    </div>

    <div id="log-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">å®Œæ•´ LOG å…§å®¹</h3>
                <div class="mt-2 px-7 py-3">
                    <pre id="full-log-content" class="text-sm text-left text-gray-700 bg-gray-100 p-4 rounded-md overflow-x-auto whitespace-pre-wrap break-words max-h-96"></pre>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- å…¨åŸŸè®Šæ•¸ ---
            const tabs = {
                logs: { btn: document.getElementById('tab-btn-logs'), content: document.getElementById('tab-content-logs') },
                qa: { btn: document.getElementById('tab-btn-qa'), content: document.getElementById('tab-content-qa') }
            };

            const logElements = {
                refreshBtn: document.getElementById('refresh-logs-btn'),
                errorDisplay: document.getElementById('logs-error-display'),
                loader: document.getElementById('logs-loader'),
                tableBody: document.getElementById('logs-table-body'),
                modal: document.getElementById('log-modal'),
                modalContent: document.getElementById('full-log-content'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                paginationControls: document.getElementById('pagination-controls'),
                // æ–°å¢ç¯©é¸å…ƒä»¶çš„åƒç…§
                filterStatus: document.getElementById('filter-status'),
                filterDate: document.getElementById('filter-date'),
                filterTicket: document.getElementById('filter-ticket'),
                filterSearchBtn: document.getElementById('filter-search-btn'),
                filterClearBtn: document.getElementById('filter-clear-btn')
            };
            
            const qaElements = {
                form: document.getElementById('qa-form'),
                input: document.getElementById('it-question-input'),
                submitBtn: document.getElementById('qa-submit-btn'),
                loader: document.getElementById('qa-loader'),
                output: document.getElementById('qa-answer-output')
            };

            let fullLogsData = []; // ç”¨æ–¼å„²å­˜å¾å¾Œç«¯ç²å–çš„å®Œæ•´æ—¥èªŒè³‡æ–™
            let filteredLogsData = []; // æ–°å¢ï¼šç”¨æ–¼å„²å­˜ç¯©é¸å¾Œçš„æ—¥èªŒè³‡æ–™
            let currentPage = 1;
            const itemsPerPage = 5;

            // --- é€šçŸ¥åŠŸèƒ½ ---
            function showNotification(message, isError = false) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `fixed top-5 right-5 z-50 px-4 py-2 rounded-lg text-white transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
            function switchTab(tabName) {
                Object.values(tabs).forEach(tab => {
                    tab.btn.classList.remove('active');
                    tab.content.classList.remove('active');
                });
                tabs[tabName].btn.classList.add('active');
                tabs[tabName].content.classList.add('active');
            }

            tabs.logs.btn.addEventListener('click', () => switchTab('logs'));
            tabs.qa.btn.addEventListener('click', () => switchTab('qa'));

            // --- Apache æ—¥èªŒåŠŸèƒ½ ---
            async function fetchLogs() {
                logElements.loader.style.display = 'flex';
                logElements.errorDisplay.style.display = 'none';
                logElements.tableBody.innerHTML = '';
                logElements.paginationControls.innerHTML = '';

                try {
                    const response = await fetch('/api/logs');
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                    }
                    const data = await response.json();
                    fullLogsData = data;
                    applyFiltersAndDisplay(); // ä¿®æ”¹ï¼šå‘¼å«æ–°çš„ä¸»å‡½å¼
                } catch (error) {
                    console.error('ç²å–æ—¥èªŒå¤±æ•—:', error);
                    logElements.errorDisplay.textContent = error.message;
                    logElements.errorDisplay.style.display = 'block';
                } finally {
                    logElements.loader.style.display = 'none';
                }
            }
            
            // æ–°å¢ï¼šå¥—ç”¨ç¯©é¸ä¸¦é¡¯ç¤ºçµæœ
            function applyFiltersAndDisplay() {
                const statusFilter = logElements.filterStatus.value;
                const dateFilter = logElements.filterDate.value;
                const ticketFilter = logElements.filterTicket.value.trim().toLowerCase();

                filteredLogsData = fullLogsData.filter(log => {
                    const matchStatus = !statusFilter || log.status === statusFilter;
                    const matchDate = !dateFilter || (log.log_date && log.log_date.startsWith(dateFilter));
                    const matchTicket = !ticketFilter || (log.ticket_number && log.ticket_number.toLowerCase().includes(ticketFilter));
                    return matchStatus && matchDate && matchTicket;
                });

                currentPage = 1; // æ¯æ¬¡ç¯©é¸å¾Œéƒ½å›åˆ°ç¬¬ä¸€é 
                displayPage();
            }

            // æ–°å¢ï¼šæ¸…é™¤ç¯©é¸æ¢ä»¶
            function clearFilters() {
                logElements.filterStatus.value = '';
                logElements.filterDate.value = '';
                logElements.filterTicket.value = '';
                applyFiltersAndDisplay();
            }

            // æ ¹æ“šç›®å‰é ç¢¼é¡¯ç¤ºè³‡æ–™
            function displayPage() {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedItems = filteredLogsData.slice(startIndex, endIndex);

                renderLogs(paginatedItems);
                setupPagination();
            }

            // è¨­å®šåˆ†é æ§åˆ¶é …çš„å‡½å¼
            function setupPagination() {
                logElements.paginationControls.innerHTML = '';
                const pageCount = Math.ceil(filteredLogsData.length / itemsPerPage);

                if (pageCount <= 1) return;

                const pageInfo = document.createElement('span');
                pageInfo.className = 'text-sm text-gray-700';
                pageInfo.textContent = `ç¬¬ ${currentPage} é ï¼Œå…± ${pageCount} é  (ç¸½è¨ˆ ${filteredLogsData.length} ç­†)`;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'inline-flex rounded-md shadow-sm -space-x-px';

                const prevButton = document.createElement('button');
                prevButton.innerHTML = 'ä¸Šä¸€é ';
                prevButton.className = 'relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50';
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayPage();
                    }
                });
                if (currentPage === 1) {
                    prevButton.disabled = true;
                    prevButton.classList.add('opacity-50', 'cursor-not-allowed');
                }

                const nextButton = document.createElement('button');
                nextButton.innerHTML = 'ä¸‹ä¸€é ';
                nextButton.className = 'relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50';
                nextButton.addEventListener('click', () => {
                    if (currentPage < pageCount) {
                        currentPage++;
                        displayPage();
                    }
                });
                if (currentPage === pageCount) {
                    nextButton.disabled = true;
                    nextButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                buttonsDiv.appendChild(prevButton);
                buttonsDiv.appendChild(nextButton);

                logElements.paginationControls.appendChild(pageInfo);
                logElements.paginationControls.appendChild(buttonsDiv);
            }

            function renderLogs(logs) {
                logElements.tableBody.innerHTML = '';
                if (logs.length === 0) {
                    logElements.tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ—¥èªŒè¨˜éŒ„ã€‚</td></tr>`;
                    return;
                }
                
                logs.forEach((log) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.id = `log-row-${log.log_id}`;

                    const originalIndex = fullLogsData.findIndex(fullLog => fullLog.log_id === log.log_id);

                    const hasTicketNumber = log.ticket_number && log.ticket_number.trim() !== '';
                    const isCompleted = log.status === 'å·²å®Œæˆ';

                    const ticketCellHTML = hasTicketNumber
                        ? `<td class="py-3 px-4 whitespace-nowrap align-middle">${log.ticket_number}</td>`
                        : `<td class="py-3 px-4 whitespace-nowrap align-middle"><input type="text" class="w-full p-1 border border-gray-300 rounded-md" placeholder="è¼¸å…¥å–®è™Ÿ..." id="ticket-input-${log.log_id}" value=""></td>`;

                    let actionCellHTML;
                    if (isCompleted) {
                        actionCellHTML = `<td class="py-3 px-4"></td>`;
                    } else {
                        const statusOptions = `
                            <option value="æœªé–‹å§‹" ${log.status === 'æœªé–‹å§‹' ? 'selected' : ''}>ğŸ”´ æœªé–‹å§‹</option>
                            <option value="é€²è¡Œä¸­" ${log.status === 'é€²è¡Œä¸­' ? 'selected' : ''}>â³ é€²è¡Œä¸­</option>
                            <option value="å·²å®Œæˆ" ${log.status === 'å·²å®Œæˆ' ? 'selected' : ''}>âœ… å·²å®Œæˆ</option>
                        `;
                        actionCellHTML = `
                            <td class="py-3 px-4 whitespace-nowrap align-middle">
                                <div class="flex items-center space-x-2">
                                    <select id="status-select-${log.log_id}" class="p-1 border border-gray-300 rounded-md text-sm">${statusOptions}</select>
                                    <button class="update-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg transition-colors" data-log-id="${log.log_id}">æ›´æ–°</button>
                                </div>
                            </td>`;
                    }

                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap view-log-btn cursor-pointer align-middle" data-index="${originalIndex}">${log.status_display}</td>
                        <td class="py-3 px-4 whitespace-nowrap view-log-btn cursor-pointer align-middle" data-index="${originalIndex}">${log.log_date}</td>
                        <td class="py-3 px-4 view-log-btn cursor-pointer align-middle" data-index="${originalIndex}">${log.log_preview}</td>
                        ${ticketCellHTML}
                        ${actionCellHTML}
                    `;
                    logElements.tableBody.appendChild(row);
                });

                document.querySelectorAll('.view-log-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = e.currentTarget.dataset.index;
                        showLogModal(index);
                    });
                });

                document.querySelectorAll('.update-btn').forEach(button => {
                    button.addEventListener('click', handleUpdateClick);
                });
            }

            async function handleUpdateClick(event) {
                const button = event.currentTarget;
                const logId = button.dataset.logId;
                
                const input = document.getElementById(`ticket-input-${logId}`);
                const statusSelect = document.getElementById(`status-select-${logId}`);
                const status = statusSelect.value;
                
                let ticketNumber;
                if (input) {
                    ticketNumber = input.value.trim();
                } else {
                    const originalLog = fullLogsData.find(log => log.log_id == logId);
                    if (originalLog) {
                        ticketNumber = originalLog.ticket_number;
                    } else {
                        showNotification('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹æ—¥èªŒè³‡æ–™ã€‚', true);
                        return;
                    }
                }

                if (!ticketNumber) {
                    showNotification('è™•ç†å–®è™Ÿä¸å¯ç‚ºç©ºã€‚', true);
                    return;
                }

                button.disabled = true;
                button.textContent = 'æ›´æ–°ä¸­...';
                button.classList.remove('bg-green-500', 'hover:bg-green-600');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');

                try {
                    const response = await fetch('/api/logs/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            log_id: parseInt(logId), 
                            ticket_number: ticketNumber,
                            status: status
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) { throw new Error(result.error || 'æ›´æ–°å¤±æ•—'); }
                    
                    showNotification('æ›´æ–°æˆåŠŸï¼');
                    
                    fetchLogs();

                } catch (error) {
                    console.error('æ›´æ–°å¤±æ•—:', error);
                    showNotification(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
                    // åªåœ¨éã€Œå·²å®Œæˆã€ç‹€æ…‹ä¸‹æ‰æ¢å¾©æŒ‰éˆ•
                    if (status !== 'å·²å®Œæˆ') {
                        button.disabled = false;
                        button.textContent = 'æ›´æ–°';
                        button.classList.add('bg-green-500', 'hover:bg-green-600');
                        button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    }
                }
            }
            
            function showLogModal(index) {
                const logData = fullLogsData[index];
                if (logData) {
                    logElements.modalContent.textContent = logData.log_data;
                    logElements.modal.style.display = 'flex';
                }
            }

            function hideLogModal() {
                logElements.modal.style.display = 'none';
            }
            
            // --- äº‹ä»¶ç›£è½å™¨ ---
            logElements.refreshBtn.addEventListener('click', fetchLogs);
            logElements.filterSearchBtn.addEventListener('click', applyFiltersAndDisplay);
            logElements.filterClearBtn.addEventListener('click', clearFilters);
            logElements.closeModalBtn.addEventListener('click', hideLogModal);
            window.addEventListener('click', (event) => {
                if (event.target === logElements.modal) {
                    hideLogModal();
                }
            });

            // --- IT çŸ¥è­˜åº«å•ç­”åŠŸèƒ½ ---
            if (qaElements.form) {
                qaElements.form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const question = qaElements.input.value.trim();
                    if (!question) {
                        qaElements.output.textContent = 'è«‹è¼¸å…¥æ‚¨çš„ IT å•é¡Œã€‚';
                        return;
                    }

                    qaElements.loader.style.display = 'flex';
                    qaElements.output.textContent = '';
                    qaElements.submitBtn.disabled = true;
                    qaElements.submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                    try {
                        const response = await fetch('/api/ask', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ question: question })
                        });
                        const data = await response.json();
                        if (!response.ok) { throw new Error(data.answer || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤'); }
                        qaElements.output.textContent = data.answer;
                    } catch (error) {
                        console.error('æŸ¥è©¢å¤±æ•—:', error);
                        qaElements.output.textContent = `æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
                    } finally {
                        qaElements.loader.style.display = 'none';
                        qaElements.submitBtn.disabled = false;
                        qaElements.submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    }
                });
            }

            // --- åˆå§‹è¼‰å…¥ ---
            fetchLogs();
        });
    </script>
</body>
</html>