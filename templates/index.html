<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT 智慧儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* 簡易的 로딩 스피너 */
        .loader {
            border: 4px solid #f3f4f6; /* gray-200 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 讓 Markdown 換行生效 */
        .markdown-content {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="notification" style="display: none;" class="fixed top-5 right-5 z-50 px-4 py-2 rounded-lg text-white transition-opacity duration-300"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">🤖 AI 助力的 IT 智慧儀表板</h1>
            <p class="text-gray-600 mt-2">請在下方的頁籤中選擇您要使用的功能。</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-btn-logs" class="tab-button active text-lg font-medium py-3 px-5 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                    📝 Apache 錯誤日誌
                </button>
                <button id="tab-btn-qa" class="tab-button text-lg font-medium py-3 px-5 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                    💡 IT 知識庫問答
                </button>
            </nav>
        </div>

        <main>
            <div id="tab-content-logs" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold w-full sm:w-auto">顯示從 Azure SQL 資料庫讀取的日誌</h2>
                        <button id="refresh-logs-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 12M20 20l-1.5-1.5A9 9 0 003.5 12"></path></svg>
                            重新整理
                        </button>
                    </div>

                    <div id="filter-controls" class="bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="filter-status" class="block text-sm font-medium text-gray-700">狀態</label>
                                <select id="filter-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="">全部</option>
                                    <option value="未開始">未開始</option>
                                    <option value="進行中">進行中</option>
                                    <option value="已完成">已完成</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-date" class="block text-sm font-medium text-gray-700">LOG 日期</label>
                                <input type="date" id="filter-date" class="mt-1 block w-full border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md p-2">
                            </div>
                            <div>
                                <label for="filter-ticket" class="block text-sm font-medium text-gray-700">處理單號</label>
                                <input type="text" id="filter-ticket" placeholder="依單號搜尋..." class="mt-1 block w-full border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md p-2">
                            </div>
                            <div class="flex space-x-2">
                                <button id="filter-search-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">查詢</button>
                                <button id="filter-clear-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">清除</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="logs-error-display" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert"></div>

                    <div id="logs-loader" class="hidden flex justify-center items-center my-8">
                        <div class="loader"></div>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="logs-table" class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">狀態</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">LOG 時間</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/6">LOG 內容預覽</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">處理單號</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">操作</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="pagination-controls" class="flex justify-between items-center mt-4">
                        </div>
                </div>
            </div>

            <div id="tab-content-qa" class="tab-content">
                
                {% if is_ai_configured %}
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-2">IT 知識庫問答</h2>
                    <p class="text-gray-600 mb-4">優先從 Qdrant 向量知識庫尋找解答。若找不到，將使用通用的 Gemini 模型回答 IT 相關問題。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <form id="qa-form">
                                <label for="it-question-input" class="block text-sm font-medium text-gray-700 mb-1">請輸入您的 IT 問題</label>
                                <textarea id="it-question-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="例如：如何清除 Chrome 瀏覽器的快取？"></textarea>
                                <button type="submit" id="qa-submit-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex justify-center items-center">
                                    查詢知識庫
                                </button>
                            </form>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">AI 回應:</h3>
                            <div id="qa-loader" class="hidden flex justify-center items-center my-8">
                                <div class="loader"></div>
                            </div>
                            <div id="qa-answer-output" class="markdown-content text-gray-800"></div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                    <p class="font-bold">AI 功能未設定</p>
                    <p>管理員尚未在伺服器上設定 Google Gemini API 金鑰。此功能目前無法使用。</p>
                </div>
                {% endif %}

            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>由 Flask 與 Google Gemini 驅動</p>
        </footer>
    </div>

    <div id="log-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">完整 LOG 內容</h3>
                <div class="mt-2 px-7 py-3">
                    <pre id="full-log-content" class="text-sm text-left text-gray-700 bg-gray-100 p-4 rounded-md overflow-x-auto whitespace-pre-wrap break-words max-h-96"></pre>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 全域變數 ---
            const tabs = {
                logs: { btn: document.getElementById('tab-btn-logs'), content: document.getElementById('tab-content-logs') },
                qa: { btn: document.getElementById('tab-btn-qa'), content: document.getElementById('tab-content-qa') }
            };

            const logElements = {
                refreshBtn: document.getElementById('refresh-logs-btn'),
                errorDisplay: document.getElementById('logs-error-display'),
                loader: document.getElementById('logs-loader'),
                tableBody: document.getElementById('logs-table-body'),
                modal: document.getElementById('log-modal'),
                modalContent: document.getElementById('full-log-content'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                paginationControls: document.getElementById('pagination-controls'),
                // 新增篩選元件的參照
                filterStatus: document.getElementById('filter-status'),
                filterDate: document.getElementById('filter-date'),
                filterTicket: document.getElementById('filter-ticket'),
                filterSearchBtn: document.getElementById('filter-search-btn'),
                filterClearBtn: document.getElementById('filter-clear-btn')
            };
            
            const qaElements = {
                form: document.getElementById('qa-form'),
                input: document.getElementById('it-question-input'),
                submitBtn: document.getElementById('qa-submit-btn'),
                loader: document.getElementById('qa-loader'),
                output: document.getElementById('qa-answer-output')
            };

            let fullLogsData = []; // 用於儲存從後端獲取的完整日誌資料
            let filteredLogsData = []; // 新增：用於儲存篩選後的日誌資料
            let currentPage = 1;
            const itemsPerPage = 5;

            // --- 通知功能 ---
            function showNotification(message, isError = false) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `fixed top-5 right-5 z-50 px-4 py-2 rounded-lg text-white transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            // --- 頁籤切換邏輯 ---
            function switchTab(tabName) {
                Object.values(tabs).forEach(tab => {
                    tab.btn.classList.remove('active');
                    tab.content.classList.remove('active');
                });
                tabs[tabName].btn.classList.add('active');
                tabs[tabName].content.classList.add('active');
            }

            tabs.logs.btn.addEventListener('click', () => switchTab('logs'));
            tabs.qa.btn.addEventListener('click', () => switchTab('qa'));

            // --- Apache 日誌功能 ---
            async function fetchLogs() {
                logElements.loader.style.display = 'flex';
                logElements.errorDisplay.style.display = 'none';
                logElements.tableBody.innerHTML = '';
                logElements.paginationControls.innerHTML = '';

                try {
                    const response = await fetch('/api/logs');
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `伺服器錯誤: ${response.status}`);
                    }
                    const data = await response.json();
                    fullLogsData = data;
                    applyFiltersAndDisplay(); // 修改：呼叫新的主函式
                } catch (error) {
                    console.error('獲取日誌失敗:', error);
                    logElements.errorDisplay.textContent = error.message;
                    logElements.errorDisplay.style.display = 'block';
                } finally {
                    logElements.loader.style.display = 'none';
                }
            }
            
            // 新增：套用篩選並顯示結果
            function applyFiltersAndDisplay() {
                const statusFilter = logElements.filterStatus.value;
                const dateFilter = logElements.filterDate.value;
                const ticketFilter = logElements.filterTicket.value.trim().toLowerCase();

                filteredLogsData = fullLogsData.filter(log => {
                    const matchStatus = !statusFilter || log.status === statusFilter;
                    const matchDate = !dateFilter || (log.log_date && log.log_date.startsWith(dateFilter));
                    const matchTicket = !ticketFilter || (log.ticket_number && log.ticket_number.toLowerCase().includes(ticketFilter));
                    return matchStatus && matchDate && matchTicket;
                });

                currentPage = 1; // 每次篩選後都回到第一頁
                displayPage();
            }

            // 新增：清除篩選條件
            function clearFilters() {
                logElements.filterStatus.value = '';
                logElements.filterDate.value = '';
                logElements.filterTicket.value = '';
                applyFiltersAndDisplay();
            }

            // 根據目前頁碼顯示資料
            function displayPage() {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedItems = filteredLogsData.slice(startIndex, endIndex);

                renderLogs(paginatedItems);
                setupPagination();
            }

            // 設定分頁控制項的函式
            function setupPagination() {
                logElements.paginationControls.innerHTML = '';
                const pageCount = Math.ceil(filteredLogsData.length / itemsPerPage);

                if (pageCount <= 1) return;

                const pageInfo = document.createElement('span');
                pageInfo.className = 'text-sm text-gray-700';
                pageInfo.textContent = `第 ${currentPage} 頁，共 ${pageCount} 頁 (總計 ${filteredLogsData.length} 筆)`;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'inline-flex rounded-md shadow-sm -space-x-px';

                const prevButton = document.createElement('button');
                prevButton.innerHTML = '上一頁';
                prevButton.className = 'relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50';
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayPage();
                    }
                });
                if (currentPage === 1) {
                    prevButton.disabled = true;
                    prevButton.classList.add('opacity-50', 'cursor-not-allowed');
                }

                const nextButton = document.createElement('button');
                nextButton.innerHTML = '下一頁';
                nextButton.className = 'relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50';
                nextButton.addEventListener('click', () => {
                    if (currentPage < pageCount) {
                        currentPage++;
                        displayPage();
                    }
                });
                if (currentPage === pageCount) {
                    nextButton.disabled = true;
                    nextButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                buttonsDiv.appendChild(prevButton);
                buttonsDiv.appendChild(nextButton);

                logElements.paginationControls.appendChild(pageInfo);
                logElements.paginationControls.appendChild(buttonsDiv);
            }

            function renderLogs(logs) {
                logElements.tableBody.innerHTML = '';
                if (logs.length === 0) {
                    logElements.tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">沒有符合條件的日誌記錄。</td></tr>`;
                    return;
                }
                
                logs.forEach((log) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.id = `log-row-${log.log_id}`;

                    const originalIndex = fullLogsData.findIndex(fullLog => fullLog.log_id === log.log_id);

                    const hasTicketNumber = log.ticket_number && log.ticket_number.trim() !== '';
                    const isCompleted = log.status === '已完成';

                    const ticketCellHTML = hasTicketNumber
                        ? `<td class="py-3 px-4 whitespace-nowrap align-middle">${log.ticket_number}</td>`
                        : `<td class="py-3 px-4 whitespace-nowrap align-middle"><input type="text" class="w-full p-1 border border-gray-300 rounded-md" placeholder="輸入單號..." id="ticket-input-${log.log_id}" value=""></td>`;

                    let actionCellHTML;
                    if (isCompleted) {
                        actionCellHTML = `<td class="py-3 px-4"></td>`;
                    } else {
                        const statusOptions = `
                            <option value="未開始" ${log.status === '未開始' ? 'selected' : ''}>🔴 未開始</option>
                            <option value="進行中" ${log.status === '進行中' ? 'selected' : ''}>⏳ 進行中</option>
                            <option value="已完成" ${log.status === '已完成' ? 'selected' : ''}>✅ 已完成</option>
                        `;
                        actionCellHTML = `
                            <td class="py-3 px-4 whitespace-nowrap align-middle">
                                <div class="flex items-center space-x-2">
                                    <select id="status-select-${log.log_id}" class="p-1 border border-gray-300 rounded-md text-sm">${statusOptions}</select>
                                    <button class="update-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg transition-colors" data-log-id="${log.log_id}">更新</button>
                                </div>
                            </td>`;
                    }

                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap view-log-btn cursor-pointer align-middle" data-index="${originalIndex}">${log.status_display}</td>
                        <td class="py-3 px-4 whitespace-nowrap view-log-btn cursor-pointer align-middle" data-index="${originalIndex}">${log.log_date}</td>
                        <td class="py-3 px-4 view-log-btn cursor-pointer align-middle" data-index="${originalIndex}">${log.log_preview}</td>
                        ${ticketCellHTML}
                        ${actionCellHTML}
                    `;
                    logElements.tableBody.appendChild(row);
                });

                document.querySelectorAll('.view-log-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = e.currentTarget.dataset.index;
                        showLogModal(index);
                    });
                });

                document.querySelectorAll('.update-btn').forEach(button => {
                    button.addEventListener('click', handleUpdateClick);
                });
            }

            async function handleUpdateClick(event) {
                const button = event.currentTarget;
                const logId = button.dataset.logId;
                
                const input = document.getElementById(`ticket-input-${logId}`);
                const statusSelect = document.getElementById(`status-select-${logId}`);
                const status = statusSelect.value;
                
                let ticketNumber;
                if (input) {
                    ticketNumber = input.value.trim();
                } else {
                    const originalLog = fullLogsData.find(log => log.log_id == logId);
                    if (originalLog) {
                        ticketNumber = originalLog.ticket_number;
                    } else {
                        showNotification('錯誤：找不到原始日誌資料。', true);
                        return;
                    }
                }

                if (!ticketNumber) {
                    showNotification('處理單號不可為空。', true);
                    return;
                }

                button.disabled = true;
                button.textContent = '更新中...';
                button.classList.remove('bg-green-500', 'hover:bg-green-600');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');

                try {
                    const response = await fetch('/api/logs/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            log_id: parseInt(logId), 
                            ticket_number: ticketNumber,
                            status: status
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) { throw new Error(result.error || '更新失敗'); }
                    
                    showNotification('更新成功！');
                    
                    fetchLogs();

                } catch (error) {
                    console.error('更新失敗:', error);
                    showNotification(`更新失敗: ${error.message}`, true);
                    // 只在非「已完成」狀態下才恢復按鈕
                    if (status !== '已完成') {
                        button.disabled = false;
                        button.textContent = '更新';
                        button.classList.add('bg-green-500', 'hover:bg-green-600');
                        button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    }
                }
            }
            
            function showLogModal(index) {
                const logData = fullLogsData[index];
                if (logData) {
                    logElements.modalContent.textContent = logData.log_data;
                    logElements.modal.style.display = 'flex';
                }
            }

            function hideLogModal() {
                logElements.modal.style.display = 'none';
            }
            
            // --- 事件監聽器 ---
            logElements.refreshBtn.addEventListener('click', fetchLogs);
            logElements.filterSearchBtn.addEventListener('click', applyFiltersAndDisplay);
            logElements.filterClearBtn.addEventListener('click', clearFilters);
            logElements.closeModalBtn.addEventListener('click', hideLogModal);
            window.addEventListener('click', (event) => {
                if (event.target === logElements.modal) {
                    hideLogModal();
                }
            });

            // --- IT 知識庫問答功能 ---
            if (qaElements.form) {
                qaElements.form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const question = qaElements.input.value.trim();
                    if (!question) {
                        qaElements.output.textContent = '請輸入您的 IT 問題。';
                        return;
                    }

                    qaElements.loader.style.display = 'flex';
                    qaElements.output.textContent = '';
                    qaElements.submitBtn.disabled = true;
                    qaElements.submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                    try {
                        const response = await fetch('/api/ask', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ question: question })
                        });
                        const data = await response.json();
                        if (!response.ok) { throw new Error(data.answer || '發生未知錯誤'); }
                        qaElements.output.textContent = data.answer;
                    } catch (error) {
                        console.error('查詢失敗:', error);
                        qaElements.output.textContent = `查詢時發生錯誤：${error.message}`;
                    } finally {
                        qaElements.loader.style.display = 'none';
                        qaElements.submitBtn.disabled = false;
                        qaElements.submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    }
                });
            }

            // --- 初始載入 ---
            fetchLogs();
        });
    </script>
</body>
</html>